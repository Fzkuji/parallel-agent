<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>American_Idol schedule</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      margin: 20px;
      color: #1f2933;
      background-color: #f8fafc;
    }
    h1 {
      margin-bottom: 0.25rem;
    }
    .metrics {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 16px;
      font-size: 0.95rem;
    }
    .metrics span {
      background: #e2e8f0;
      padding: 6px 12px;
      border-radius: 999px;
    }
    .slider {
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .slider input[type=range] {
      width: 320px;
    }
    svg {
      background: #ffffff;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.12);
    }
    .edge {
      stroke: #cbd5e1;
      stroke-width: 2px;
      opacity: 0.7;
    }
    .edge.done {
      stroke: #0ea5e9;
      opacity: 0.9;
    }
    .edge.current {
      stroke: #f97316;
      opacity: 0.95;
    }
    .node {
      stroke: #1e293b;
      stroke-width: 2px;
    }
    .node.pending {
      fill: #f1f5f9;
    }
    .node.done {
      fill: #0ea5e9;
    }
    .node.current {
      fill: #f97316;
    }
    text {
      font-size: 12px;
      text-anchor: middle;
    }
    text.id {
      font-weight: 600;
      font-size: 14px;
      fill: #0f172a;
    }
    text.label {
      fill: #1f2937;
    }
    .info {
      margin-top: 16px;
      padding: 12px;
      background: #e0f2fe;
      border-left: 4px solid #0284c7;
      border-radius: 4px;
      font-size: 0.95rem;
      max-width: 900px;
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <h1>American_Idol schedule</h1>
  <div class="metrics" id="metrics"></div>
  <div class="slider">
    <label for="batchSlider">批次选择：</label>
    <input type="range" min="0" id="batchSlider" />
    <span id="batchLabel"></span>
  </div>
  <svg id="graph"></svg>
  <div class="info" id="batchInfo"></div>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    const data = {"title": "American_Idol schedule", "nodes": [{"id": "Q1", "label": "Who was the winner of American Idols ninth season?", "short_label": "Who was the wi…", "priority": 1.0, "answer_tokens": 12, "prompt_tokens": 12, "dependencies": [], "layer": 0, "x": 110.0, "y": 70.0, "depth": 0}, {"id": "Q2", "label": "What U2 song was released by Lee DeWyze after winning American Idol?", "short_label": "What U2 song w…", "priority": 1.0, "answer_tokens": 12, "prompt_tokens": 16, "dependencies": ["Q1"], "layer": 1, "x": 450.0, "y": 210.0, "depth": 1}, {"id": "Q3", "label": "When was the finale held?", "short_label": "When was the f…", "priority": 1.0, "answer_tokens": 12, "prompt_tokens": 7, "dependencies": [], "layer": 0, "x": 110.0, "y": 350.0, "depth": 0}, {"id": "Q4", "label": "Who won this season of Idol?", "short_label": "Who won this s…", "priority": 1.0, "answer_tokens": 12, "prompt_tokens": 8, "dependencies": ["Q1", "Q2"], "layer": 2, "x": 790.0, "y": 70.0, "depth": 2}, {"id": "Q5", "label": "What song did DeWyze cover for his first release?", "short_label": "What song did …", "priority": 1.0, "answer_tokens": 12, "prompt_tokens": 12, "dependencies": ["Q2"], "layer": 2, "x": 790.0, "y": 350.0, "depth": 2}], "edges": [{"source": "Q1", "target": "Q4"}, {"source": "Q1", "target": "Q2"}, {"source": "Q2", "target": "Q5"}, {"source": "Q2", "target": "Q4"}], "batches": [{"id": 0, "nodes": ["Q1", "Q3"], "depth": 0, "value": 2.0, "priority_sum": 2.0, "tokens": {"background": 91, "incremental": 19, "generation": 24, "total": 134}, "estimated_latency": 102.4}, {"id": 1, "nodes": ["Q2"], "depth": 1, "value": 0.5, "priority_sum": 1.0, "tokens": {"background": 91, "incremental": 34, "generation": 12, "total": 137}, "estimated_latency": 114.4}, {"id": 2, "nodes": ["Q4", "Q5"], "depth": 2, "value": 0.667, "priority_sum": 2.0, "tokens": {"background": 91, "incremental": 74, "generation": 24, "total": 189}, "estimated_latency": 146.4}], "metrics": {"total_background_tokens": 273, "total_incremental_tokens": 127, "total_generation_tokens": 60, "total_compute_tokens": 460, "total_estimated_latency": 363.2, "value_score": 3.167}, "config": {"width": 900, "height": 420}};
    const svg = d3.select("#graph")
      .attr("width", data.config.width)
      .attr("height", data.config.height);

    const nodeById = Object.fromEntries(data.nodes.map(d => [d.id, d]));

    const edges = svg.selectAll("line")
      .data(data.edges)
      .enter()
      .append("line")
      .attr("class", "edge")
      .attr("x1", d => nodeById[d.source].x)
      .attr("y1", d => nodeById[d.source].y)
      .attr("x2", d => nodeById[d.target].x)
      .attr("y2", d => nodeById[d.target].y);

    const nodeGroups = svg.selectAll("g.node-group")
      .data(data.nodes)
      .enter()
      .append("g")
      .attr("class", "node-group")
      .attr("transform", d => `translate(${d.x}, ${d.y})`);

    nodeGroups.append("circle")
      .attr("r", 28)
      .attr("class", "node pending");

    nodeGroups.append("text")
      .attr("class", "id")
      .attr("y", -2)
      .text(d => d.id);

    nodeGroups.append("text")
      .attr("class", "label")
      .attr("y", 16)
      .text(d => d.short_label);

    nodeGroups.append("title")
      .text(d => `${d.id}\n优先级: ${d.priority} | 回答 tokens: ${d.answer_tokens}`);

    const slider = document.getElementById("batchSlider");
    slider.setAttribute("max", data.batches.length);
    slider.value = 0;

    const batchLabel = document.getElementById("batchLabel");
    const batchInfo = document.getElementById("batchInfo");
    const metricsContainer = document.getElementById("metrics");

    const metricsEntries = [
      ["Value score", data.metrics.value_score],
      ["Compute tokens", data.metrics.total_compute_tokens],
      ["Background tokens", data.metrics.total_background_tokens],
      ["Incremental tokens", data.metrics.total_incremental_tokens],
      ["Generation tokens", data.metrics.total_generation_tokens],
      ["Estimated latency", data.metrics.total_estimated_latency]
    ];
    metricsEntries.forEach(([label, value]) => {
      const span = document.createElement("span");
      span.textContent = `${label}: ${value}`;
      metricsContainer.appendChild(span);
    });

    function update(step) {
      const executed = new Set();
      for (let i = 0; i < step; i += 1) {
        data.batches[i].nodes.forEach(n => executed.add(n));
      }
      const current = new Set(step > 0 ? data.batches[step - 1].nodes : []);

      nodeGroups.selectAll("circle")
        .attr("class", d => {
          if (current.has(d.id)) return "node current";
          if (executed.has(d.id)) return "node done";
          return "node pending";
        });

      nodeGroups.selectAll("text.id")
        .attr("fill", d => current.has(d.id) ? "#ffffff" : executed.has(d.id) ? "#0b3d3d" : "#0f172a");

      nodeGroups.selectAll("text.label")
        .attr("fill", d => current.has(d.id) ? "#fff7ed" : executed.has(d.id) ? "#022c22" : "#1f2937");

      edges.attr("class", d => {
        if (current.has(d.target)) return "edge current";
        if (executed.has(d.target)) return "edge done";
        return "edge";
      });

      if (step === 0) {
        batchLabel.textContent = "步骤 0：未执行任何批次";
        batchInfo.textContent = "拖动滑块以查看每个批次的节点、token 成本和估计延迟。";
      } else {
        const batch = data.batches[step - 1];
        const lines = [
          `批次 ${batch.id} ，节点：${batch.nodes.join(", ")}`,
          `深度：${batch.depth} | Value score：${batch.value.toFixed(3)} | 优先级和：${batch.priority_sum.toFixed(3)}`,
          `Token：background={batch.tokens.background}, incremental={batch.tokens.incremental}, generation={batch.tokens.generation}, total={batch.tokens.total}`,
          `估计延迟：${batch.estimated_latency.toFixed(1)}`
        ];
        batchLabel.textContent = `步骤 ${step}：批次 ${batch.id}`;
        batchInfo.textContent = lines.join("\n");
      }
    }

    slider.addEventListener("input", (event) => update(Number(event.target.value)));
    update(0);
  </script>
</body>
</html>
